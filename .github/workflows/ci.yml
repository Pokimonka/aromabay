# –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ workflow (–ø–∞–π–ø–ª–∞–π–Ω–∞)
name: CI/CD Pipeline

# –ö–û–ì–î–ê –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —ç—Ç–æ—Ç workflow?
on:
  # –ü—Ä–∏ –ø—É—à–µ –≤ —ç—Ç–∏ –≤–µ—Ç–∫–∏:
  push:
    branches: [ develop, staging, main ]
  # –ò –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ —ç—Ç–∏ –≤–µ—Ç–∫–∏:
  pull_request:
    branches: [ develop, staging, main ]

# –ß–¢–û –¥–µ–ª–∞–µ—Ç –Ω–∞—à workflow? –û–ø–∏—Å—ã–≤–∞–µ–º jobs (–∑–∞–¥–∞—á–∏)
jobs:
  # üîß –ó–ê–î–ê–ß–ê 1: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ç–∫–µ–Ω–¥–∞
  test-backend:
    # –ù–∞ –∫–∞–∫–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–ø—É—Å–∫–∞–µ–º
    runs-on: ubuntu-latest
    
    # –°–µ—Ä–≤–∏—Å—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–∫–∞–∫ docker-compose –Ω–æ –¥–ª—è CI)
    services:
      # –ó–∞–ø—É—Å–∫–∞–µ–º PostgreSQL –¥–ª—è —Ç–µ—Å—Ç–æ–≤
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # –ó–∞–ø—É—Å–∫–∞–µ–º RabbitMQ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672

    # –®–ê–ì–ò –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4
      
    # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±—ç–∫–µ–Ω–¥–∞
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    # –®–∞–≥ 4: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –±—ç–∫–µ–Ω–¥–∞
    - name: Run backend tests
      run: |
        cd backend
        python -m pytest tests/ -v
      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤:
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        SECRET_KEY: jvepox9awxJEsrT_KRQLiigA8estyMp6AqLrTbzAjRU
        RABBITMQ_URL: amqp://guest:guest@localhost:5672/

  # ü§ñ –ó–ê–î–ê–ß–ê 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –±–æ—Ç–∞
  test-bot:
    runs-on: ubuntu-latest
    # –≠–¢–û–¢ job –∂–¥–µ—Ç –ø–æ–∫–∞ test-backend –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
    needs: test-backend
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install bot dependencies
      run: |
        cd tg_bot
        pip install -r requirements.txt
    
    - name: Run bot tests
      run: |
        cd tg_bot
        python -m pytest tests/ -v
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
        TELEGRAM_BOT_TOKEN: "8295415758:AAHiUC12K2lqngvaKrh8kpTIpodSjhe8weU"
        ADMIN_IDS: "6473177486"

    - name: Check bot syntax
      run: |
        cd tg_bot
        python -c "import app.bot, app.shared_bot; print('‚úÖ All bot modules import successfully')"

  # üê≥ –ó–ê–î–ê–ß–ê 3: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
  build-docker:
    runs-on: ubuntu-latest
    # –ñ–¥–µ–º –ø–æ–∫–∞ –í–°–ï —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥—É—Ç
    needs: [test-backend, test-bot]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –±—ç–∫–µ–Ω–¥–∞
    - name: Build backend image
      run: |
        cd backend
        docker build -t aromabay-backend:latest .
    
    # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ –±–æ—Ç–∞
    - name: Build bot image
      run: |
        cd tg_bot
        docker build -t aromabay-bot:latest .

  # üöÄ –ó–ê–î–ê–ß–ê 4: –î–µ–ø–ª–æ–π –Ω–∞ STAGING —Å–µ—Ä–≤–µ—Ä
  deploy-staging:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø—É—à–µ –≤ staging –≤–µ—Ç–∫—É
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    needs: build-docker  # –ñ–¥–µ–º —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_SERVER_IP }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd ~/aromabay
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          docker compose down || true
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ
          docker system prune -f
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          git clone https://github.com/–í–ê–®_–ù–ò–ö–ù–ï–ô–ú/aromabay.git . || git pull origin staging
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç
          docker compose up -d --build
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
          docker ps
          echo "üöÄ Staging deployment completed!"
          
  # üéØ –ó–ê–î–ê–ß–ê 5: –î–µ–ø–ª–æ–π –Ω–∞ PRODUCTION —Å–µ—Ä–≤–µ—Ä
  deploy-production:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø—É—à–µ –≤ main –≤–µ—Ç–∫—É
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to production
      run: |
        echo "üéØ –î–µ–ø–ª–æ–π –Ω–∞ PRODUCTION —Å–µ—Ä–≤–µ—Ä"
        echo "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ –±–æ–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä"
        # –ü–æ–∑–∂–µ –¥–æ–±–∞–≤–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–µ–ø–ª–æ—è
      env:
        SERVER_URL: ${{ secrets.PRODUCTION_SERVER_URL }}
        SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
