# ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑˆÐµÐ³Ð¾ workflow (Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ð°)
name: CI/CD Pipeline

# ÐšÐžÐ“Ð”Ð Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÑÑ‚Ð¾Ñ‚ workflow?
on:
  # ÐŸÑ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² ÑÑ‚Ð¸ Ð²ÐµÑ‚ÐºÐ¸:
  push:
    branches: [ develop, staging, main ]
  # Ð˜ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Pull Request Ð² ÑÑ‚Ð¸ Ð²ÐµÑ‚ÐºÐ¸:
  pull_request:
    branches: [ develop, staging, main ]

# Ð§Ð¢Ðž Ð´ÐµÐ»Ð°ÐµÑ‚ Ð½Ð°Ñˆ workflow? ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ jobs (Ð·Ð°Ð´Ð°Ñ‡Ð¸)
jobs:
  # ðŸ”§ Ð—ÐÐ”ÐÐ§Ð 1: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð±ÑÐºÐµÐ½Ð´Ð°
  test-backend:
    # ÐÐ° ÐºÐ°ÐºÐ¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
    runs-on: ubuntu-latest
    
    # Ð¡ÐµÑ€Ð²Ð¸ÑÑ‹ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð² (ÐºÐ°Ðº docker-compose Ð½Ð¾ Ð´Ð»Ñ CI)
    services:
      # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PostgreSQL Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ RabbitMQ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
      rabbitmq:
        image: rabbitmq:3-management
        ports:
          - 5672:5672

    # Ð¨ÐÐ“Ð˜ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾:
    steps:
    # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð±ÑÐºÐµÐ½Ð´Ð°
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    # Ð¨Ð°Ð³ 4: Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ð±ÑÐºÐµÐ½Ð´Ð°
    - name: Run backend tests
      run: |
        cd backend
        python -m pytest tests/ -v
      # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²:
      env:
        TELEGRAM_BOT_TOKEN: "8295415758:AAHiUC12K2lqngvaKrh8kpTIpodSjh8fake"
        SECRET_KEY: jvepox9awxJEsrT_KRQLiigA8estyMp6AqLrTbzFake
        RABBITMQ_URL: amqp://guest:guest@localhost:5672/

  # ðŸ¤– Ð—ÐÐ”ÐÐ§Ð 2: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Telegram Ð±Ð¾Ñ‚Ð°
  test-bot:
    runs-on: ubuntu-latest
    # Ð­Ð¢ÐžÐ¢ job Ð¶Ð´ÐµÑ‚ Ð¿Ð¾ÐºÐ° test-backend Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑÑ
    needs: test-backend
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install bot dependencies
      run: |
        cd tg_bot
        pip install -r requirements.txt
    
    - name: Run bot tests
      run: |
        cd tg_bot
        python -m pytest tests/ -v
      env:
        DATABASE_URL: postgresql://fake:fake@localhost:5432/postgres
        TELEGRAM_BOT_TOKEN: "8295415758:AAHiUC12K2lqngvaKrh8kpTIpodSjh8fake"
        ADMIN_IDS: "6473177486"

    - name: Check bot syntax
      run: |
        cd tg_bot
        python -c "import app.bot, app.shared_bot; print('âœ… All bot modules import successfully')"
      env:
        DATABASE_URL: postgresql://fake:fake@localhost:5432/postgres
        TELEGRAM_BOT_TOKEN: "8295415758:AAHiUC12K2lqngvaKrh8kpTIpodSjh8fake"

  # ðŸ³ Ð—ÐÐ”ÐÐ§Ð 3: Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
  build-docker:
    runs-on: ubuntu-latest
    # Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Ð’Ð¡Ð• Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÑƒÑ‚
    needs: [test-backend, test-bot]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð±ÑÐºÐµÐ½Ð´Ð°
    - name: Build backend image
      run: |
        cd backend
        docker build -t aromabay-backend:latest .
    
    # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð±Ð¾Ñ‚Ð°
    - name: Build bot image
      run: |
        cd tg_bot
        docker build -t aromabay-bot:latest .

  # ðŸš€ Ð—ÐÐ”ÐÐ§Ð 4: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° STAGING ÑÐµÑ€Ð²ÐµÑ€
  deploy-staging:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² staging Ð²ÐµÑ‚ÐºÑƒ
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    needs: build-docker  # Ð–Ð´ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_SERVER_IP }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd ~/aromabay
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
          docker compose down || true
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¼ÐµÑÑ‚Ð¾
          docker system prune -f
          # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
          git clone https://github.com/Pokimonka/aromabay.git . || git pull origin staging
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
	cat > .env << EOF
	# Database
	DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
	DATABASE_PASSWORD=${{ secrets.STAGING_DATABASE_PASSWORD }}
	
	# Telegram Bot
	TELEGRAM_BOT_TOKEN=${{ secrets.STAGING_TELEGRAM_BOT_TOKEN }}
	ADMIN_IDS=6473177486
	
	# RabbitMQ
	RABBITMQ_URL=amqp://${{ secrets.STAGING_RABBITMQ_USER }}:${{ secrets.STAGING_RABBITMQ_PASSWORD }}@rabbitmq:5672/
	RABBITMQ_USER=${{ secrets.STAGING_RABBITMQ_USER }}
	RABBITMQ_PASSWORD=${{ secrets.STAGING_RABBITMQ_PASSWORD }}
	
	# FastAPI
	SECRET_KEY=${{ secrets.STAGING_SECRET_KEY }}
	EOF
	
	# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼
	docker compose down
	docker compose up -d --build
	echo "ðŸš€ Staging deployment completed!"
          
  # ðŸŽ¯ Ð—ÐÐ”ÐÐ§Ð 5: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° PRODUCTION ÑÐµÑ€Ð²ÐµÑ€
  deploy-production:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¢ÐžÐ›Ð¬ÐšÐž Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main Ð²ÐµÑ‚ÐºÑƒ
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to production
      run: |
        echo "ðŸŽ¯ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° PRODUCTION ÑÐµÑ€Ð²ÐµÑ€"
        echo "Ð—Ð´ÐµÑÑŒ Ð±ÑƒÐ´ÐµÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð° Ð±Ð¾ÐµÐ²Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€"
        # ÐŸÐ¾Ð·Ð¶Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´ÐµÐ¿Ð»Ð¾Ñ
      env:
        SERVER_URL: ${{ secrets.PRODUCTION_SERVER_URL }}
        SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
